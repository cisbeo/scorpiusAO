# üá´üá∑ BOAMP Integration - Documentation Compl√®te

**Date**: 2025-10-02
**Branche**: `boamp-analytics`
**Status**: ‚úÖ Impl√©mentation Compl√®te

---

## üìã Table des Mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture](#architecture)
3. [API BOAMP](#api-boamp)
4. [Sch√©ma Base de Donn√©es](#sch√©ma-base-de-donn√©es)
5. [Services](#services)
6. [T√¢ches Celery](#t√¢ches-celery)
7. [Endpoints API](#endpoints-api)
8. [Filtrage Intelligent](#filtrage-intelligent)
9. [Workflow Complet](#workflow-complet)
10. [Configuration & D√©ploiement](#configuration--d√©ploiement)
11. [Tests & Validation](#tests--validation)
12. [Monitoring](#monitoring)

---

## Vue d'ensemble

### Objectif

Automatiser la veille et la r√©cup√©ration des **appels d'offres publics fran√ßais** pertinents pour l'entreprise depuis le **BOAMP** (Bulletin Officiel des Annonces des March√©s Publics).

### P√©rim√®tre

- **Source**: BOAMP (data.gouv.fr via Opendatasoft)
- **Secteur cible**: Infrastructure IT, h√©bergement datacenter, services informatiques
- **Fr√©quence**: Synchronisation horaire automatique
- **Filtrage**: CPV codes + mots-cl√©s + montant minimum

### Gains M√©tier

- **Couverture exhaustive**: 100% des AO publics IT en France
- **R√©activit√©**: D√©tection < 1h apr√®s publication
- **Productivit√©**: √âlimination veille manuelle (2-3h/jour ‚Üí 0h)
- **Opportunit√©s**: 30-50 nouveaux tenders/mois identifi√©s

---

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         BOAMP API                               ‚îÇ
‚îÇ    boamp-datadila.opendatasoft.com/api/explore/v2.1            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ HTTP GET (hourly)
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     Celery Beat Scheduler                       ‚îÇ
‚îÇ              fetch_boamp_publications_task                      ‚îÇ
‚îÇ                   (cron: 0 * * * *)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ Fetch & Filter
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      BOAMPService                               ‚îÇ
‚îÇ  - filter_relevant_publications()                               ‚îÇ
‚îÇ    ‚Ä¢ CPV codes (IT infrastructure)                              ‚îÇ
‚îÇ    ‚Ä¢ Keywords (17 termes)                                       ‚îÇ
‚îÇ    ‚Ä¢ Montant min (10K‚Ç¨)                                         ‚îÇ
‚îÇ  - parse_publication()                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ Save to DB
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                PostgreSQL: boamp_publications                   ‚îÇ
‚îÇ  status: new | imported | ignored | error                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ User Review
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  FastAPI Endpoints                              ‚îÇ
‚îÇ  GET  /boamp/publications (list + filters)                      ‚îÇ
‚îÇ  POST /boamp/publications/{id}/import                           ‚îÇ
‚îÇ  GET  /boamp/stats                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ Import Action
                            ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              import_boamp_as_tender_task                        ‚îÇ
‚îÇ  - Create Tender (source='BOAMP')                               ‚îÇ
‚îÇ  - Link matched_tender_id                                       ‚îÇ
‚îÇ  - Update status='imported'                                     ‚îÇ
‚îÇ  - TODO: Trigger processing pipeline                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## API BOAMP

### Endpoint Principal

```
https://boamp-datadila.opendatasoft.com/api/explore/v2.1/catalog/datasets/boamp/records
```

### Param√®tres Query

| Param√®tre | Type | Description | Exemple |
|-----------|------|-------------|---------|
| `limit` | int | Nombre max de r√©sultats | `100` |
| `order_by` | string | Tri | `dateparution desc` |
| `where` | string | Filtres SQL-like | `dateparution >= date'2025-10-01'` |
| `select` | string | Colonnes √† retourner | `*` (toutes) |

### Exemple Requ√™te

```bash
curl "https://boamp-datadila.opendatasoft.com/api/explore/v2.1/catalog/datasets/boamp/records?\
limit=100&\
order_by=dateparution%20desc&\
where=dateparution%20%3E%3D%20date'2025-10-01'"
```

### Structure R√©ponse

```json
{
  "total_count": 1234,
  "results": [
    {
      "record": {
        "id": "boamp-123456789",
        "timestamp": "2025-10-02T10:00:00Z",
        "fields": {
          "objet": "H√©bergement infrastructure datacenter...",
          "acheteur": "Minist√®re de l'Int√©rieur",
          "dateparution": "2025-10-02",
          "datelimitereponse": "2025-11-15",
          "typeannonce": "Avis de march√©",
          "montant": "250000.00",
          "codecpv": ["72000000", "50324000"],
          "descripteurs": ["h√©bergement", "datacenter"],
          "lieuexecution": "Paris (75)"
        }
      }
    }
  ]
}
```

### Champs BOAMP Importants

| Champ | Type | Description |
|-------|------|-------------|
| `objet` | string | Titre de l'annonce |
| `acheteur` / `nomorganisme` | string | Organisation acheteuse |
| `dateparution` | date | Date de publication au BOAMP |
| `datelimitereponse` | date | Date limite de r√©ponse |
| `typeannonce` | string | Type (Avis de march√©, R√©sultat, etc.) |
| `montant` | decimal | Montant estim√© du march√© |
| `codecpv` | array | Codes CPV (nomenclature europ√©enne) |
| `descripteurs` | array | Mots-cl√©s descripteurs |
| `lieuexecution` | string | Lieu d'ex√©cution du march√© |

---

## Sch√©ma Base de Donn√©es

### Table `boamp_publications`

```sql
CREATE TABLE boamp_publications (
    -- Identit√©
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    boamp_id VARCHAR(100) UNIQUE NOT NULL,  -- ID unique BOAMP

    -- Informations Tender
    title TEXT NOT NULL,
    organization VARCHAR(500),
    publication_date DATE NOT NULL,
    deadline DATE,

    -- Champs BOAMP sp√©cifiques
    type_annonce VARCHAR(100),
    objet TEXT,
    montant NUMERIC(15,2),
    lieu_execution VARCHAR(500),

    -- Classification
    cpv_codes JSONB DEFAULT '[]',         -- Codes CPV europ√©ens
    descripteurs JSONB DEFAULT '[]',      -- Mots-cl√©s BOAMP

    -- Donn√©es brutes
    raw_data JSONB NOT NULL,              -- JSON complet de l'API

    -- Statut & Tra√ßabilit√©
    status VARCHAR(50) DEFAULT 'new',     -- new | imported | ignored | error
    matched_tender_id UUID REFERENCES tenders(id) ON DELETE SET NULL,
    imported_at TIMESTAMP WITH TIME ZONE,

    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Contraintes
    CONSTRAINT check_boamp_status CHECK (status IN ('new', 'imported', 'ignored', 'error'))
);
```

### Indexes

```sql
-- Index unique sur boamp_id (d√©duplication)
CREATE UNIQUE INDEX ix_boamp_publications_boamp_id ON boamp_publications(boamp_id);

-- Index pour tri par date (derni√®res publications)
CREATE INDEX idx_boamp_publication_date_desc ON boamp_publications(publication_date DESC);

-- Index pour filtrage par statut
CREATE INDEX ix_boamp_publications_status ON boamp_publications(status);

-- Index GIN pour recherche CPV codes (JSONB)
CREATE INDEX idx_boamp_cpv_codes ON boamp_publications USING GIN(cpv_codes);

-- Index GIN pour recherche descripteurs (JSONB)
CREATE INDEX idx_boamp_descripteurs ON boamp_publications USING GIN(descripteurs);
```

### Diagramme Relations

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   boamp_publications ‚îÇ
‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ-‚îÇ
‚îÇ id (PK)              ‚îÇ
‚îÇ boamp_id (UNIQUE)    ‚îÇ
‚îÇ title                ‚îÇ
‚îÇ ...                  ‚îÇ
‚îÇ matched_tender_id ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îê
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
                           ‚îÇ
                           ‚îÇ FK
                           ‚îÇ
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ   tenders    ‚îÇ
                      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
                      ‚îÇ id (PK)      ‚îÇ
                      ‚îÇ source       ‚îÇ
                      ‚îÇ ...          ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Services

### BOAMPService (`app/services/boamp_service.py`)

#### M√©thodes

##### 1. `fetch_latest_publications(limit=100, days_back=7)`

R√©cup√®re les derni√®res publications depuis l'API BOAMP.

**Param√®tres**:
- `limit` (int): Nombre max de publications √† r√©cup√©rer
- `days_back` (int): Nombre de jours en arri√®re depuis aujourd'hui
- `filters` (dict, optional): Filtres additionnels (type_annonce, montant_min)

**Retour**: `List[Dict[str, Any]]` - Liste de publications brutes

**Exemple**:
```python
publications = await boamp_service.fetch_latest_publications(
    limit=50,
    days_back=3,
    filters={"type_annonce": "Avis de march√©"}
)
```

##### 2. `filter_relevant_publications(publications, min_amount=10000)`

Filtre les publications pour ne garder que celles pertinentes (IT infrastructure).

**Filtres appliqu√©s**:
- **CPV codes**: V√©rifie si codes commencent par 72**, 503*, etc. (IT)
- **Keywords**: Recherche dans title + objet + descripteurs
- **Montant**: Filtre par montant minimum

**Param√®tres**:
- `publications` (list): Publications brutes de l'API
- `min_amount` (float, optional): Montant minimum en euros (default: 10000)
- `check_keywords` (bool): Activer filtrage par mots-cl√©s (default: True)
- `check_cpv` (bool): Activer filtrage par CPV codes (default: True)

**Retour**: `List[Dict[str, Any]]` - Publications filtr√©es

**Exemple**:
```python
relevant = boamp_service.filter_relevant_publications(
    publications,
    min_amount=50000,  # Minimum 50K‚Ç¨
    check_keywords=True,
    check_cpv=True
)
```

##### 3. `parse_publication(raw_publication)`

Parse une publication brute de l'API en format structur√© pour l'ORM.

**Transformations**:
- Extrait champs depuis `fields` nested dict
- Parse dates ISO ‚Üí `date` objects
- Convertit montant string ‚Üí `float`
- Normalise CPV codes / descripteurs en listes

**Param√®tres**:
- `raw_publication` (dict): Publication brute de l'API

**Retour**: `Dict[str, Any]` - Donn√©es structur√©es pour BOAMPPublication

**Exemple**:
```python
parsed = boamp_service.parse_publication(raw_pub)
# {
#   "boamp_id": "boamp-123",
#   "title": "H√©bergement datacenter",
#   "organization": "Minist√®re X",
#   "publication_date": date(2025, 10, 2),
#   "deadline": date(2025, 11, 15),
#   "cpv_codes": ["72000000"],
#   "raw_data": {...}  # Original complet
# }
```

#### Constantes

##### CPV Codes Pertinents (IT Infrastructure)

```python
RELEVANT_CPV_CODES = [
    "72000000",  # Services informatiques
    "72260000",  # Services logiciels
    "72500000",  # Services de conseil en informatique
    "50324000",  # H√©bergement de sites informatiques
    "72700000",  # Services de r√©seau informatique
    "72310000",  # Services de traitement de donn√©es
    "72400000",  # Services internet
    "72600000",  # Services de soutien informatique
    "72410000",  # Services de fournisseur de services internet
    "72254000",  # Services de conseil en tests
    "72253000",  # Services de conseil en assistance informatique
    "72800000",  # Services de conseil en mat√©riel informatique
]
```

##### Mots-cl√©s de Recherche

```python
KEYWORDS = [
    "h√©bergement", "datacenter", "infrastructure", "itil",
    "iso 27001", "supervision", "support", "maintenance informatique",
    "infog√©rance", "cloud", "serveur", "virtualisation",
    "stockage", "sauvegarde", "s√©curit√© informatique",
    "r√©seau", "syst√®me d'information"
]
```

---

## T√¢ches Celery

### 1. `fetch_boamp_publications_task`

**Type**: P√©riodique (Celery Beat)
**Fr√©quence**: Toutes les heures (cron: `0 * * * *`)
**Timeout**: 30 min

**Workflow**:
```
1. Fetch publications BOAMP API (async HTTP)
2. Filter par CPV codes + keywords + montant
3. Parse chaque publication
4. Check d√©duplication (boamp_id exists?)
5. Save nouvelles publications en DB (status='new')
6. Return stats: {fetched, filtered, saved, duplicates}
```

**Param√®tres**:
- `days_back` (int): Jours en arri√®re (default: 1 pour runs horaires)
- `limit` (int): Max publications √† fetch (default: 100)

**Gestion erreurs**:
- Retry 3x avec backoff exponentiel (60s, 120s, 240s)
- Logging d√©taill√© (INFO/ERROR)

**Exemple d√©clenchement manuel**:
```python
from app.tasks.boamp_tasks import fetch_boamp_publications_task

result = fetch_boamp_publications_task.delay(days_back=7, limit=200)
```

---

### 2. `import_boamp_as_tender_task`

**Type**: √Ä la demande (trigger API)
**Timeout**: 30 min

**Workflow**:
```
1. Load BOAMPPublication by ID
2. Check status (skip if already imported)
3. Create Tender record:
   - title, organization, deadline
   - reference_number = boamp_id
   - source = 'BOAMP'
   - parsed_content = BOAMP metadata (CPV, montant, etc.)
4. Update BOAMPPublication:
   - status = 'imported'
   - matched_tender_id = tender.id
   - imported_at = NOW()
5. TODO: Download documents PDF
6. TODO: Trigger process_tender_documents pipeline
```

**Param√®tres**:
- `boamp_publication_id` (str UUID): ID de la publication √† importer

**Gestion erreurs**:
- Retry 3x avec backoff
- Si erreur: status='error'

**Exemple d√©clenchement**:
```python
from app.tasks.boamp_tasks import import_boamp_as_tender_task

result = import_boamp_as_tender_task.delay("uuid-here")
```

---

### 3. `cleanup_old_boamp_publications_task`

**Type**: P√©riodique (Celery Beat)
**Fr√©quence**: Hebdomadaire (Dimanche 3h du matin)

**Workflow**:
```
1. Calculate cutoff date (today - days_to_keep)
2. Delete publications WHERE:
   - publication_date < cutoff_date
   - status IN ('new', 'ignored')
3. Keep imported publications (linked to tenders)
4. Return deleted_count
```

**Param√®tres**:
- `days_to_keep` (int): Jours √† conserver (default: 90)

---

## Endpoints API

### Base URL: `/api/v1/boamp`

---

### GET `/publications`

Liste pagin√©e des publications BOAMP avec filtres.

**Query Parameters**:
| Param | Type | Required | Description |
|-------|------|----------|-------------|
| `status` | string | No | Filtre par statut: new, imported, ignored, error |
| `date_from` | date | No | Publications √† partir de cette date (YYYY-MM-DD) |
| `date_to` | date | No | Publications jusqu'√† cette date (YYYY-MM-DD) |
| `page` | int | No | Num√©ro de page (default: 1) |
| `page_size` | int | No | Items par page (default: 50, max: 100) |

**Response**: `BOAMPPublicationList`
```json
{
  "items": [
    {
      "id": "uuid",
      "boamp_id": "boamp-123",
      "title": "H√©bergement infrastructure datacenter",
      "organization": "Minist√®re de l'Int√©rieur",
      "publication_date": "2025-10-02",
      "deadline": "2025-11-15",
      "type_annonce": "Avis de march√©",
      "montant": 250000.0,
      "cpv_codes": ["72000000"],
      "status": "new",
      "days_until_deadline": 44,
      "created_at": "2025-10-02T10:00:00Z"
    }
  ],
  "total": 123,
  "page": 1,
  "page_size": 50,
  "has_next": true
}
```

**Exemple cURL**:
```bash
curl "http://localhost:8000/api/v1/boamp/publications?\
status=new&\
date_from=2025-10-01&\
page=1&\
page_size=20"
```

---

### GET `/publications/{id}`

R√©cup√®re une publication sp√©cifique par UUID.

**Path Parameters**:
- `id` (UUID): ID de la publication

**Response**: `BOAMPPublicationResponse` (+ raw_data complet)

**Exemple**:
```bash
curl "http://localhost:8000/api/v1/boamp/publications/uuid-here"
```

---

### POST `/publications/{id}/import`

Importe une publication BOAMP ‚Üí cr√©e un Tender.

**Path Parameters**:
- `id` (UUID): ID de la publication √† importer

**Request Body**: `BOAMPImportRequest` (vide, juste trigger)
```json
{}
```

**Response**: `BOAMPImportResponse`
```json
{
  "status": "processing",
  "task_id": "celery-task-uuid",
  "message": "Import task started. Check task status for completion."
}
```

**Status possibles**:
- `processing`: T√¢che Celery lanc√©e
- `already_imported`: D√©j√† import√© (renvoie tender_id)

**Exemple**:
```bash
curl -X POST "http://localhost:8000/api/v1/boamp/publications/uuid-here/import" \
  -H "Content-Type: application/json" \
  -d '{}'
```

---

### POST `/sync`

D√©clenche manuellement une synchronisation BOAMP.

**Request Body**: `BOAMPSyncRequest`
```json
{
  "days_back": 7,
  "limit": 100,
  "force": false
}
```

**Response**: `BOAMPSyncResponse`
```json
{
  "status": "processing",
  "task_id": "celery-task-uuid",
  "message": "Sync task started. Fetching publications from last 7 days."
}
```

**Exemple**:
```bash
curl -X POST "http://localhost:8000/api/v1/boamp/sync" \
  -H "Content-Type: application/json" \
  -d '{"days_back": 3, "limit": 50}'
```

---

### GET `/stats`

Statistiques sur les publications BOAMP.

**Response**: `BOAMPStatsResponse`
```json
{
  "total_publications": 345,
  "new_count": 120,
  "imported_count": 200,
  "ignored_count": 20,
  "error_count": 5,
  "publications_last_24h": 15,
  "publications_last_7d": 87,
  "avg_days_to_deadline": 38.5,
  "total_montant": 12500000.00
}
```

**Exemple**:
```bash
curl "http://localhost:8000/api/v1/boamp/stats"
```

---

### PATCH `/publications/{id}/ignore`

Marque une publication comme ignor√©e (non pertinente).

**Path Parameters**:
- `id` (UUID): ID de la publication

**Response**:
```json
{
  "status": "success",
  "message": "Publication marked as ignored"
}
```

**Exemple**:
```bash
curl -X PATCH "http://localhost:8000/api/v1/boamp/publications/uuid-here/ignore"
```

---

## Filtrage Intelligent

### Strat√©gie Multi-Crit√®res

Le filtrage combine **3 m√©thodes** pour maximiser la pr√©cision:

1. **CPV Codes** (Classification europ√©enne)
2. **Keywords** (Mots-cl√©s m√©tier)
3. **Montant minimum** (Seuil de pertinence)

### D√©tail CPV Codes

Les codes CPV (Common Procurement Vocabulary) sont une nomenclature europ√©enne standardis√©e.

**Format**: 8 chiffres (ex: `72000000`)

**Hi√©rarchie**:
- 2 premiers chiffres: Division (ex: `72` = Services informatiques)
- 4 premiers chiffres: Groupe (ex: `7200` = Services informatiques g√©n√©raux)
- 6 premiers chiffres: Classe
- 8 chiffres: Cat√©gorie compl√®te

**Matching**: On match les **4 premiers chiffres** pour couvrir tous les sous-types.

**Exemple**:
- `72000000` ‚Üí Services informatiques (g√©n√©ral)
- `72260000` ‚Üí Services logiciels
- `72262000` ‚Üí Services de d√©veloppement logiciel (match aussi)

### Exemples de Filtrage

#### Cas 1: Match CPV uniquement

```json
{
  "objet": "Fourniture de mat√©riel bureautique",
  "codecpv": ["72000000"],
  "descripteurs": ["bureautique", "ordinateurs"]
}
```

‚úÖ **Accept√©** (CPV 72000000 = informatique)

---

#### Cas 2: Match Keywords uniquement

```json
{
  "objet": "H√©bergement de serveurs pour la DREAL",
  "codecpv": ["63000000"],  // Services postaux
  "descripteurs": ["h√©bergement", "serveurs"]
}
```

‚úÖ **Accept√©** (keyword "h√©bergement" trouv√©)

---

#### Cas 3: Rejet√© (ni CPV ni keywords)

```json
{
  "objet": "Nettoyage des locaux administratifs",
  "codecpv": ["90000000"],  // Services de nettoyage
  "descripteurs": ["nettoyage", "entretien"]
}
```

‚ùå **Rejet√©** (aucun crit√®re IT)

---

#### Cas 4: Rejet√© (montant trop faible)

```json
{
  "objet": "Support informatique ponctuel",
  "codecpv": ["72000000"],
  "montant": "5000"
}
```

‚ùå **Rejet√©** (montant < 10K‚Ç¨)

---

## Workflow Complet

### Sc√©nario: Publication Automatique

```
10:00 ‚Üí BOAMP publie nouveau tender "H√©bergement datacenter Minist√®re X"
        (codecpv: 72000000, montant: 250K‚Ç¨)

10:30 ‚Üí Celery Beat trigger fetch_boamp_publications_task
        ‚îî‚îÄ Fetch API BOAMP (derni√®res 24h)
        ‚îî‚îÄ 120 publications r√©cup√©r√©es

10:31 ‚Üí Filter publications
        ‚îî‚îÄ Check CPV codes: 72000000 ‚úÖ
        ‚îî‚îÄ Check keywords: "h√©bergement" ‚úÖ
        ‚îî‚îÄ Check montant: 250K‚Ç¨ > 10K‚Ç¨ ‚úÖ
        ‚îî‚îÄ 15 publications pertinentes retenues

10:32 ‚Üí Save to database
        ‚îî‚îÄ Check boamp_id exists? Non ‚Üí INSERT
        ‚îî‚îÄ status='new'
        ‚îî‚îÄ 15 nouvelles publications sauvegard√©es

11:00 ‚Üí User ouvre UI ScorpiusAO
        ‚îî‚îÄ GET /api/v1/boamp/publications?status=new
        ‚îî‚îÄ Affichage liste: 15 nouvelles opportunit√©s

11:15 ‚Üí User review publication "H√©bergement datacenter"
        ‚îî‚îÄ GET /api/v1/boamp/publications/{uuid}
        ‚îî‚îÄ Lecture d√©tails (deadline, montant, CPV, raw_data)

11:20 ‚Üí User d√©cide d'importer
        ‚îî‚îÄ POST /api/v1/boamp/publications/{uuid}/import
        ‚îî‚îÄ Response: {"status": "processing", "task_id": "..."}

11:21 ‚Üí Celery execute import_boamp_as_tender_task
        ‚îî‚îÄ Create Tender (source='BOAMP')
        ‚îî‚îÄ tender_id = uuid-tender
        ‚îî‚îÄ Update boamp_publication:
           - status='imported'
           - matched_tender_id=uuid-tender
           - imported_at=NOW()

11:22 ‚Üí Tender cr√©√©
        ‚îî‚îÄ TODO: Download PDF documents
        ‚îî‚îÄ TODO: Trigger process_tender_documents pipeline
        ‚îî‚îÄ User peut maintenant analyser ce tender

12:00 ‚Üí User consulte stats
        ‚îî‚îÄ GET /api/v1/boamp/stats
        ‚îî‚îÄ Affichage dashboard:
           - 345 publications totales
           - 120 nouvelles (status=new)
           - 200 import√©es
           - 15 ajout√©es derni√®res 24h
```

---

## Configuration & D√©ploiement

### Variables d'Environnement

Aucune variable sp√©cifique BOAMP requise. L'API est publique et gratuite.

**Celery configur√© via**:
```python
# app/core/config.py
CELERY_BROKER_URL = "amqp://guest@localhost:5672//"
CELERY_RESULT_BACKEND = "redis://localhost:6379/0"
```

### Celery Beat Schedule

**Fichier**: `app/core/celery_app.py`

```python
celery_app.conf.beat_schedule = {
    # Fetch BOAMP hourly
    "fetch-boamp-hourly": {
        "task": "app.tasks.boamp_tasks.fetch_boamp_publications_task",
        "schedule": crontab(minute=0),  # Every hour at :00
        "kwargs": {"days_back": 1, "limit": 100},
    },
    # Cleanup weekly
    "cleanup-boamp-weekly": {
        "task": "app.tasks.boamp_tasks.cleanup_old_boamp_publications_task",
        "schedule": crontab(hour=3, minute=0, day_of_week=0),  # Sunday 3 AM
        "kwargs": {"days_to_keep": 90},
    },
}
```

### D√©marrage Services

#### 1. API FastAPI

```bash
cd backend
uvicorn app.main:app --reload --port 8000
```

#### 2. Celery Worker

```bash
celery -A app.core.celery_app worker --loglevel=info
```

#### 3. Celery Beat (Scheduler)

```bash
celery -A app.core.celery_app beat --loglevel=info
```

#### 4. Flower (Monitoring Celery)

```bash
celery -A app.core.celery_app flower --port=5555
```

**Dashboard**: http://localhost:5555

### Docker Compose (Production)

Ajouter service Celery Beat:

```yaml
# docker-compose.yml

services:
  celery-beat:
    build: .
    command: celery -A app.core.celery_app beat --loglevel=info
    depends_on:
      - postgres
      - redis
      - rabbitmq
    environment:
      - DATABASE_URL=postgresql+asyncpg://user:pass@postgres/db
      - CELERY_BROKER_URL=amqp://guest@rabbitmq:5672//
```

---

## Tests & Validation

### Test Manuel - Fetch API

```python
import asyncio
from app.services.boamp_service import boamp_service

async def test_fetch():
    pubs = await boamp_service.fetch_latest_publications(limit=10, days_back=1)
    print(f"Fetched {len(pubs)} publications")

    relevant = boamp_service.filter_relevant_publications(pubs)
    print(f"Filtered {len(relevant)} relevant")

asyncio.run(test_fetch())
```

### Test Manuel - Import

```bash
# 1. Sync BOAMP
curl -X POST "http://localhost:8000/api/v1/boamp/sync" \
  -H "Content-Type: application/json" \
  -d '{"days_back": 7, "limit": 50}'

# 2. List publications
curl "http://localhost:8000/api/v1/boamp/publications?status=new"

# 3. Import une publication
curl -X POST "http://localhost:8000/api/v1/boamp/publications/{uuid}/import" \
  -H "Content-Type: application/json" \
  -d '{}'

# 4. V√©rifier tender cr√©√©
curl "http://localhost:8000/api/v1/tenders"
```

### Validation Base de Donn√©es

```sql
-- Check publications sauvegard√©es
SELECT COUNT(*), status FROM boamp_publications GROUP BY status;

-- Publications derni√®res 24h
SELECT COUNT(*) FROM boamp_publications
WHERE created_at >= NOW() - INTERVAL '24 hours';

-- Publications import√©es avec lien tender
SELECT bp.boamp_id, bp.title, t.id as tender_id, t.status
FROM boamp_publications bp
INNER JOIN tenders t ON bp.matched_tender_id = t.id
WHERE bp.status = 'imported';
```

---

## Monitoring

### Logs Celery

```bash
# Worker logs
tail -f /var/log/celery/worker.log

# Beat logs
tail -f /var/log/celery/beat.log
```

### M√©triques Cl√©s

| M√©trique | Objectif | Comment Mesurer |
|----------|----------|-----------------|
| **Latence d√©tection** | < 1h | time(publication BOAMP) ‚Üí time(saved DB) |
| **Taux filtrage** | 70-80% pertinents | saved / filtered |
| **Performance sync** | < 30s pour 100 pubs | task duration |
| **Taux import** | 30-50% import√©s | imported / new |

### Flower Dashboard

**URL**: http://localhost:5555

**M√©triques**:
- Tasks succeeded / failed
- Task duration histograms
- Worker status
- Queue lengths

### Alertes Recommand√©es

1. **Pas de publications 24h** ‚Üí Check API BOAMP ou schedule
2. **Taux d'erreur > 10%** ‚Üí Check logs Celery
3. **Queue length > 100** ‚Üí Scale workers
4. **Task duration > 5min** ‚Üí Investigate slow API

---

## Prochaines Am√©liorations (Phase 2)

### Priorit√© Haute

- [ ] **Download PDF documents** depuis BOAMP URLs
  - Endpoint: `/boamp/publications/{id}/documents`
  - Save in MinIO
  - Link to TenderDocument

- [ ] **Trigger processing pipeline** apr√®s import
  - Auto-start `process_tender_documents`
  - Extract text, analyze, extract criteria
  - Complete workflow automation

- [ ] **Notifications critiques**
  - Email/Slack si montant > 500K‚Ç¨
  - Notification si deadline < 15 jours
  - Dashboard badge "X nouveaux tenders"

### Priorit√© Moyenne

- [ ] **ML-based relevance scoring**
  - Train model sur publications (imported vs ignored)
  - Auto-score nouvelles publications (0-100%)
  - Auto-import si score > 80%

- [ ] **Analytics & Trends**
  - Dashboard: √âvolution publications/mois
  - Montants moyens par secteur
  - D√©lais moyens deadline
  - Taux de succ√®s import

- [ ] **Smart search**
  - Full-text search dans objet + raw_data
  - Facettes: CPV, montant range, organization
  - Suggestions auto-complete

### Priorit√© Basse

- [ ] **Multi-source integration**
  - AWS PLACE (Plateforme des Achats de l'√âtat)
  - March√©s r√©gionaux (Bretagne, Occitanie)
  - Autres plateformes publiques

- [ ] **Export Excel**
  - Export publications filtered
  - Template pre-filled pour analyse

---

## Support & Contact

**Documentation**: Ce fichier
**Code**: `backend/app/` (boamp_*.py)
**Issues**: GitHub Issues
**API BOAMP**: donnees-dila@dila.gouv.fr

---

*Derni√®re mise √† jour: 2025-10-02*
*Auteur: Claude Code*
*Version: 1.0*
